#!/usr/bin/env perl

use 5.010_001;
use strict;
use warnings;

use constant PKG => 'Compress::LZ4Frame';

use Test::More tests => 11;

# try using
BEGIN { use_ok(PKG, ':all') };

# check interface
can_ok(PKG, 'compress');
can_ok(PKG, 'compress_checksum');
can_ok(PKG, 'decompress');
can_ok(PKG, 'looks_like_lz4frame');

# try some simple compression
my @data = map { $_ => rand } (1..50000);
my $input = pack 'd*', @data;
my $compressed = compress $input;
my $decompressed = decompress $compressed;
is($decompressed, $input, 'decompressing compressed data yields original');
ok(length $compressed < length $input, 'compressed data is smaller than original');

# check the checker
ok(looks_like_lz4frame($compressed), 'compressed data should be detected as such');
ok(!looks_like_lz4frame($decompressed), 'uncompressed data should be detected as such');

# check decompressing concatenated data
my $catted_compressed = $compressed . $compressed;
my $catted_original = $input . $input;
my $catted_decompressed = decompress $catted_compressed;
is($catted_decompressed, $catted_original, 'decompressing concatenated frames yields concatenated original');

# check decompressing data without size info
my $lorem_compressed =
    "\x04\x22\x4d\x18\x64\x70\xb9\x07\x03\x00\x00\xf2\x5c\x4c\x6f\x72"
.   "\x65\x6d\x20\x69\x70\x73\x75\x6d\x20\x46\x75\x67\x69\x61\x74\x20"
.   "\x63\x6f\x6e\x73\x65\x63\x74\x65\x74\x75\x72\x20\x65\x78\x65\x72"
.   "\x63\x69\x74\x61\x74\x69\x6f\x6e\x20\x6d\x61\x67\x6e\x61\x20\x63"
.   "\x69\x6c\x6c\x75\x6d\x20\x69\x72\x75\x72\x65\x20\x65\x75\x20\x65"
.   "\x6e\x69\x6d\x20\x63\x75\x70\x69\x64\x61\x74\x61\x74\x0a\x44\x75"
.   "\x69\x73\x20\x6c\x61\x62\x6f\x72\x65\x20\x6e\x6f\x6e\x20\x71\x75"
.   "\x69\x20\x76\x65\x6e\x69\x61\x6d\x2a\x00\x72\x61\x6c\x69\x71\x75"
.   "\x69\x70\x66\x00\xa0\x71\x75\x61\x74\x20\x70\x61\x72\x69\x61\x6d"
.   "\x00\x59\x75\x74\x20\x55\x74\x73\x00\x18\x0a\x8c\x00\xd2\x6e\x6f"
.   "\x73\x74\x72\x75\x64\x20\x64\x6f\x6c\x6f\x72\x06\x00\xd1\x65\x20"
.   "\x70\x72\x6f\x69\x64\x65\x6e\x74\x20\x75\x74\x6f\x00\xe3\x73\x65"
.   "\x64\x20\x74\x65\x6d\x70\x6f\x72\x20\x65\x73\x74\xb3\x00\x23\x69"
.   "\x6e\x92\x00\xf1\x01\x0a\x71\x75\x69\x20\x69\x6e\x63\x69\x64\x69"
.   "\x64\x75\x6e\x74\x20\xad\x00\x03\x9e\x00\x03\xd8\x00\x92\x76\x6f"
.   "\x6c\x75\x70\x74\x61\x74\x65\xaf\x00\xd2\x69\x6e\x20\x73\x69\x6e"
.   "\x74\x20\x6d\x69\x6e\x69\x6d\x30\x00\x83\x65\x6c\x69\x74\x20\x69"
.   "\x6e\x0a\x38\x00\x01\x5a\x00\xe1\x75\x6d\x20\x72\x65\x70\x72\x65"
.   "\x68\x65\x6e\x64\x65\x72\x20\x00\x04\xa2\x00\xa2\x69\x6e\x20\x65"
.   "\x69\x75\x73\x6d\x6f\x64\x85\x00\x80\x69\x73\x20\x64\x65\x73\x65"
.   "\x72\x80\x00\x92\x45\x78\x63\x65\x70\x74\x65\x75\x72\x37\x01\x02"
.   "\xda\x00\x05\x4c\x01\x02\x24\x01\x04\x8a\x01\x00\x76\x00\x00\xde"
.   "\x00\x14\x69\x89\x01\x01\x2e\x00\xe2\x65\x20\x63\x6f\x6d\x6d\x6f"
.   "\x64\x6f\x20\x61\x75\x74\x65\xa1\x00\x31\x69\x6e\x0a\x95\x00\x37"
.   "\x65\x20\x66\xd2\x01\x01\x6c\x01\x30\x6d\x6f\x6c\x48\x00\x63\x6e"
.   "\x6f\x6e\x20\x64\x6f\x1e\x01\x00\x14\x01\x22\x61\x64\x61\x00\xb0"
.   "\x61\x64\x69\x70\x69\x73\x69\x63\x69\x6e\x67\xe3\x00\x08\x7f\x01"
.   "\x12\x76\xf8\x00\x01\xf7\x01\x17\x55\xb6\x01\x09\x33\x00\x12\x64"
.   "\x82\x00\x00\x7b\x01\x07\x67\x01\x04\xe2\x01\x20\x0a\x61\x45\x01"
.   "\x02\x4b\x01\x04\x14\x00\x04\x1d\x02\x02\x50\x02\x03\xa0\x00\x62"
.   "\x61\x64\x20\x73\x69\x74\x42\x01\x00\x64\x02\xb2\x75\x74\x20\x6f"
.   "\x63\x63\x61\x65\x63\x61\x74\x45\x01\x80\x75\x6d\x20\x73\x75\x6e"
.   "\x74\x0a\x26\x00\x03\x88\x01\x00\x68\x01\x12\x75\x5f\x02\x14\x61"
.   "\x48\x00\x22\x69\x6e\x90\x00\x01\x0f\x01\x73\x75\x6d\x20\x65\x73"
.   "\x73\x65\xc9\x00\x02\x03\x01\x10\x6c\x26\x01\x02\x41\x00\x71\x0a"
.   "\x6f\x66\x66\x69\x63\x69\x2e\x02\x04\x6b\x02\x05\x75\x00\x01\x5d"
.   "\x01\x03\x2f\x00\x02\xaa\x00\x23\x61\x64\x0c\x01\x00\x83\x00\x05"
.   "\x86\x02\x04\x8d\x01\x66\x6e\x6f\x6e\x0a\x65\x61\xb5\x00\x02\x63"
.   "\x00\x34\x20\x65\x78\x3f\x03\x01\x5d\x02\x28\x75\x74\x6f\x02\x00"
.   "\x9c\x00\x43\x63\x75\x6c\x70\xda\x01\x06\x54\x03\x73\x20\x6e\x75"
.   "\x6c\x6c\x61\x0a\xa1\x02\x0a\x68\x02\x04\xaa\x00\x06\x48\x00\x03"
.   "\x27\x00\x00\x1f\x01\x01\x45\x01\x00\xa0\x00\x01\x04\x00\x00\x71"
.   "\x02\x01\xcc\x02\x00\x7c\x00\x1a\x0a\x47\x00\x06\x74\x02\x05\x98"
.   "\x01\x71\x61\x64\x20\x6e\x69\x73\x69\x44\x00\x08\x08\x02\x08\x0c"
.   "\x00\x00\x21\x00\x10\x0a\x9d\x00\x39\x6d\x63\x6f\xae\x02\x02\x2b"
.   "\x04\x02\x2a\x01\x01\x37\x01\x01\x9d\x03\x05\x74\x01\x08\x84\x03"
.   "\x00\xb8\x01\x00\xfb\x00\x23\x61\x64\xaf\x02\x12\x0a\x21\x02\x01"
.   "\xf5\x00\x00\x11\x04\x08\x61\x02\x00\x95\x00\x26\x6f\x6e\x38\x03"
.   "\x02\x23\x02\xe0\x65\x20\x75\x6c\x6c\x61\x6d\x63\x6f\x20\x65\x61"
.   "\x2e\x0a\x00\x00\x00\x00\x35\xfc\x38\xce";
my $lorem_decompressed = decompress $lorem_compressed;
my $lorem_original = <<'EOF';
Lorem ipsum Fugiat consectetur exercitation magna cillum irure eu enim cupidatat
Duis labore non qui veniam enim aliquip consequat pariatur ut Ut exercitation
consectetur nostrud dolor dolore proident ut non sed tempor est magna in labore
qui incididunt Duis veniam cillum voluptate enim in sint minim Duis elit in
veniam laborum reprehenderit in dolore in eiusmod laboris deserunt Excepteur
Duis dolor cupidatat consectetur elit sed in magna dolore commodo aute Duis in
labore fugiat consequat mollit non do magna qui ad elit adipisicing in
consectetur velit irure Ut pariatur adipisicing id Duis est incididunt pariatur
anim minim pariatur veniam irure mollit ad sit dolor eu ut occaecat laborum sunt
sit veniam in eu aliqua mollit in Duis laborum esse velit non dolore veniam
officia in nostrud occaecat aute dolore irure ad irure sit proident commodo non
ea occaecat veniam ex cillum enim ut voluptate esse culpa dolor cupidatat nulla
cillum reprehenderit nostrud voluptate cillum sunt sit sit sit sunt sint enim
reprehenderit cupidatat pariatur ad nisi sit consectetur consectetur nisi
ullamco consectetur magna irure dolor non non dolor incididunt in esse ad fugiat
minim nulla Ut adipisicing ad non Excepteur dolore ullamco ea.
EOF
is($lorem_decompressed, $lorem_original, 'decompressing frames where size header is 0 should work');
